
# 联合文件系统
联合文件系统（Union System UnionFS） 是一种轻量级且高性能的文件系统。它支持将文件系统中的修改信息作为一次提交，并层层叠加。同时，它可以将不同目录挂载到同一个虚拟文件系统下，像是使用一个目录一样。


## 基本概念与原理


1. 分层结构：
   
   联合文件系统将多个文件系统层，以一种有效的方式组合在一起，形成了一个单一的可读写的文件系统。这些层可以是只读的，也可以是可读写的，但通常只有最顶层是可写的，而底层则提供基础数据和共享内容

2. 联合挂载
   
   联合文件系统使用联合挂载技术，将多个目录(或文件系统)，合并成一个统一的视图。这个统一的视图对于应用来说就像是一个普通的文件系统，但它实际上是由多个底层的文件系统层组成的。

3. 写时复制
   
   这是联合文件系统的一个重要特征。当对文件进行写操作时，系统不会在原文件上直接修改，而是在可写层创建一个文件的副本，然后在该副本上进行修改。这样只读层的文件就受到了保护，而修改则限制在最顶层的可写层中。

## 主要特点与优势

1. 提高存储效率
   
   通过分层结构，联合文件系统可以共享公共层，从而避免冗余数据的存储。这意味着只要安装一个程序或者镜像，其依赖的公共层就只需要被下载或安装一次，大大的节省了存储空间

2. 更好的依赖管理和隔离
   
   分层结构可以使得依赖管理变得容易。例如，在 Docker 中，可以通过继承基础镜像来复用其能力，并在此基础上进行扩展和定制。同时分层结构还确保了各层之间的隔离性，层与层之间的操作不受影响。

## 应用场景

1. Docker 镜像
   
   联合文件系统是实现 Docker 镜像的技术基础。 Docker 镜像通过分层的方式存储和管理文件和目录，使得镜像的创建，分发和管理变得更加高效和灵活。

2. 多磁盘分区合并
   
   联合文件系统还可以用于在多个磁盘分区上合并不同的文件系统的主目录，从而简化文件系统的管理

3. 数据备份与恢复，通过创建只读层可以对其进行备份，可以在需要时款速恢复数据到某个指定的状态

## 常见实现

- AUFS（Advanced Multi-Layered unified Filesystem）：AUFS是一种广泛使用的联合文件系统类型，它实现了对多层的高效管理。AUFS在Linux系统中得到了广泛的支持和应用。
  
- OverlayFS：OverlayFS是另一种常用的联合文件系统类型。与AUFS相比，它使用一种简化的方法来创建和管理覆盖目录。OverlayFS在Linux 3.18版本中被合并到内核中，并在后续的版本中得到了不断的改进和优化。


- Btrfs（B-Tree Filesystem）：Btrfs是一种现代文件系统，它除了提供快照和校验和等高级存储特性外，还支持与联合文件系统的兼容性。这使得Btrfs可以在某些场景下作为联合文件系统的底层存储使用。
- ZFS（Z文件系统）：ZFS是一个高容量和健壮的存储平台，它提供了联合文件系统特性以及数据保护、压缩和重复数据删除等功能。ZFS在某些特定的应用场景下具有独特的优势。


# 联合文件系统与Docker


Docker 中最常用的联合文件系统有三种：AUFS、Devicemapper 和 OverlayFS。

AUFS 是 Docker 最早使用的文件系统驱动，多用于 Ubuntu 和 Debian 系统中。在 Docker 早期，OverlayFS 和 Devicemapper 相对不够成熟，AUFS 是最早也是最稳定的文件系统驱动。

# 配置 Docker 的 AUFS 模式


AUFS 目前并未合并到 Linux 内核主线，因此只有 Ubuntu 和 Debian等少数操作系统支持 AUFS，可以使用以下命令查看是否支持 AUFS
```bash
$ grep aufs /proc/filesystems
# 如果看到以下输出则说明支持
nodev   aufs
```

配置docker 使用 aufs ：在 `/etc/docker` 下新建 `daemon.json` 文件，并写入以下内容
```json
{
  "storage-driver": "aufs"
}
```
重启Docker
```bash
sudo systemctl restart docker
```

Docker 重启以后使用docker info命令即可查看配置是否生效：
```bash
$ sudo docker info
Client:
 Debug Mode: false
Server:
 Containers: 0
  Running: 0
  Paused: 0
  Stopped: 0
 Images: 1
 Server Version: 19.03.12
 Storage Driver: aufs
  Root Dir: /var/lib/docker/aufs
  Backing Filesystem: extfs
  Dirs: 1
  Dirperm1 Supported: true
```

可以看到 Storage Driver 已经变为 aufs，证明配置已经生效，配置生效后就可以使用 AUFS 为 Docker 提供联合文件系统了。

# AUFS的工作原理


## AUFS是如何存储文件的