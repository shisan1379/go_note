# OverlayFS发展史

OverlayFS 的发展分为两个阶段。2014 年，OverlayFS 第一个版本被合并到 Linux 内核 3.18 版本中，此时的 OverlayFS 在 Docker 中被称为overlay文件驱动。由于第一版的overlay文件系统存在很多弊端（例如运行一段时间后Docker 会报 "too many links problem" 的错误）， Linux 内核在 4.0 版本对overlay做了很多必要的改进，此时的 OverlayFS 被称之为overlay2。

因此，在 Docker 中 OverlayFS 文件驱动被分为了两种，一种是早期的overlay，不推荐在生产环境中使用，另一种是更新和更稳定的overlay2，推荐在生产环境中使用

# 使用 overlay2 的先决条件

overlay2虽然很好，但是它的使用是有一定条件限制的。

- 要想使用overlay2，Docker 版本必须高于 17.06.02。
- 如果你的操作系统是 RHEL 或 CentOS，Linux 内核版本必须使用 3.10.0-514 或者更高版本，其他 Linux 发行版的内核版本必须高于 4.0（例如 Ubuntu 或 Debian），你可以使用uname -a查看当前系统的内核版本。

# 配置 xfs 文件系统

overlay2最好搭配 xfs 文件系统使用，并且使用 xfs 作为底层文件系统时，d_type必须开启，可以使用以下步骤验证 d_type 是否开启：

1. 找到挂载点：使用 df 命令来查看 /var/lib/docker 目录所在的挂载点和对应的设备。

   ```bash
   root@what-virtual-machine:/home/what# df -h /var/lib/docker
    文件系统        大小  已用  可用 已用% 挂载点
    /dev/sda1        20G   13G  6.8G   65% /
   ```

   其中 /dev/sda1 是文件系统设备。
2. 使用 xfs_info 检查是否启用了 d_type

   ```bash
   root@what-virtual-machine:/home/what# xfs_info /dev/sda1 | grep ftype
    naming   =version 2              bsize=4096   ascii-ci=0, ftype=1
   ```

   如果启用了 d_type，您应该会看到类似 ftype=1 的输出。

   - ftype=0 表示未启用文件类型支持。
   - ftype=1 表示启用了文件类型支持。
3. 如果 ftype=0 则需要重新格式化磁盘目录

   ```bash
   # 假设您要格式化的设备是 /dev/sda1，并且希望启用 d_type 支持  
   mkfs.xfs -n ftype=1 /dev/sda1
   ```

d_type 字段的含义

> 在 XFS 文件系统中，d_type 是 Linux 内核的一个术语，表示“目录条目类型”（directory entry type）。目录条目是文件系统上目录信息的一个数据结构，而 d_type 就是这个数据结构中的一个字段，用于指示文件或目录的类型。
>
> 具体来说，d_type 字段可以用来区分一个目录条目是文件、目录、管道、套接字还是其他类型的文件系统对象。这个特性在 Linux 内核中从 2.6 版本开始就已经支持，但并非所有的文件系统都实现了 d_type。对于 XFS 文件系统来说，它可以选择性地支持 d_type，这通常是在文件系统格式化时通过指定相应的选项来实现的。


另外，在生产环境中，推荐挂载 /var/lib/docker 目录到单独的磁盘或者磁盘分区，这样可以避免该目录写满影响主机的文件写入，并且把挂载信息写入到 /etc/fstab，防止机器重启后挂载信息丢失。

# 开启 pquota

挂载配置中推荐开启 pquota，这样可以防止某个容器写文件溢出导致整个容器目录空间被占满

pquota，特别是与 XFS 文件系统结合使用时，代表的是项目配额（Project Quota）的管理功能。**项目配额是一种配额管理机制，它允许系统管理员根据特定的项目或任务来分配和限制文件系统资源（如磁盘空间和文件数量）**。这与传统的基于用户或用户组的配额管理不同，后者主要关注个体用户的资源使用情况。

pquota 的主要作用包括：


1. **资源分配**：管理员可以为不同的项目分配特定的磁盘空间限制和/或文件数量限制。这有助于确保每个项目都有足够的资源来完成其任务，同时防止单个项目过度消耗资源。
   
2. **资源监控**：通过 pquota，管理员可以监控每个项目的资源使用情况。这有助于及时发现和解决资源不足或过度使用的问题。
   
3. **资源限制**：当某个项目达到其配额限制时，pquota 可以阻止该项目进一步写入数据或创建文件。这有助于防止文件系统因资源耗尽而崩溃。
   
4. **提高资源利用率**：通过为不同项目分配合理的资源限制，pquota 可以帮助组织更有效地利用磁盘空间和其他文件系统资源。
   
5. **增强安全性**：通过限制每个项目的资源使用，pquota 可以降低因单个项目资源过度使用而导致的安全风险。



开启 `pquota` 需在 `/etc/fstab` 中挂载目录时，配置参数， `/etc/fstab` 结构如下：

```bash
# <file system> <mount point>   <type>  <options>       <dump>  <pass>
# / was on /dev/sda1 during installation
UUID=2a6db30e-e8ee-4be1-b9be-5ea4f88991ca /               xfs     defaults        0       0
# /d2 was on /dev/sda2 during installation
UUID=c5f4dc3b-6291-43bf-bc8d-5cea1170ccb1 /d2             xfs     defaults        0       0
```
1. 设备（Filesystem）：指定要挂载的设备或文件系统。这可以是设备的名称（如 /dev/sda1）、UUID（如 UUID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx）或标签（如 LABEL=xxxxxxx）。
1. 挂载点（Mount point）：指定文件系统的挂载点，即一个目录。当系统启动时，文件系统会被挂载到这个目录下，用户可以通过这个目录访问文件系统上的文件。
文件系统类型（Type）：指定文件系统的类型，如 ext4、xfs、ntfs、swap 等。这是系统识别和处理文件系统所必需的。

1. 挂载选项（Options）：指定挂载时的选项，这些选项可以影响文件系统的性能和行为。常见的选项包括 defaults、noatime、nosuid、ro、rw、exec、noexec、suid、nosuid、user、nouser 等。
2. dump 备份设置：用于控制是否对该文件系统进行备份。通常设置为 0 表示不备份，1 表示参与完整备份。这个字段主要被 dump 备份工具使用。
   - defaults：使用默认的挂载选项，通常包括 rw、suid、dev、exec、auto 等。
   - noatime：不更新文件或目录的访问时间，可以提高文件系统的性能。
   - nosuid：不允许在文件系统上执行 SUID 和 SGID 程序，提高系统的安全性。
   - ro：以只读方式挂载文件系统。
   - rw：以可读写方式挂载文件系统（默认）。
   - exec：允许在文件系统上执行二进制文件。
   - noexec：不允许在文件系统上执行任何二进制文件。
   - suid：允许设置用户 ID（SUID）和组 ID（SGID）。
   - user：允许普通用户挂载该文件系统。
   - nouser：只允许 root 用户挂载该文件系统（默认）。
  

3. fsck 检查顺序：指定文件系统检查（fsck）的顺序。通常设置为 0 表示不检查，1 表示在根文件系统之后检查，2 表示以并行方式检查。这个字段主要被 fsck 命令使用。

根据以上书写规则我们将为 docker 开启 pquota 需增加一行
```bash
/dev/sda2 /var/lib/docker xfs defaults,pquota 0 0
```
直接使用命令追加也可
```bash
sudo echo "/dev/sda2 /var/lib/docker xfs defaults,pquota 0 0" >> /etc/fstab
```

然后重新挂载使得挂载目录生效
```bash
sudo mount -a
```
这样我们就为 `/dev/sda2` 分区挂载到了 `/var/lib/docker` 目录，并开启了 `pquota`


# 在Docker中配置overlay2

文档
<https://docs.docker.com/reference/cli/docker/container/run/>


## 设置容器默认大小

1. 停止已经运行的 Docker：
   ```bash
   sudo systemctl stop docker
   ```
2. 备份 /var/lib/docker 目录：
   ```bash
   sudo cp -au /var/lib/docker /var/lib/docker.back
   ```
3. 设置容器的默认最大大小。仅当后备文件系统为 xfs 并使用 pquota 挂载选项挂载时，才支持此功能。在这些情况下，用户可以传递小于后备文件系统大小的任何大小。
   ```bash
    sudo dockerd -s overlay2 --storage-opt overlay2.size=1G
   ```

4. 启动 Docker：
   ```bash
   $ sudo systemctl start docker
   ```
5. 检查配置是否生效：
   ```bash
   $ docker info
   ```
   输出包含 overlay2 即为生效



## 设置单个容器文件系统大小限制


```bash
docker run -it --storage-opt size=120G fedora /bin/bash
```
此 （size） 在创建时将容器文件系统大小限制为 120G。此选项仅适用于 btrfs、overlay2、windowsfilter 和 zfs 存储驱动程序。
