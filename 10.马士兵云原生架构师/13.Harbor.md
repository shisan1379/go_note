
# 官网

<https://goharbor.io/docs/2.14.0/install-config/>


# 安装配置

## 准备好pv

使用本地存储

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-storage
provisioner: kubernetes.io/no-provisioner  # 本地存储无自动供应者，需手动创建 PV 关联
reclaimPolicy: Retain  # 保留数据，避免误删
#volumeBindingMode: WaitForFirstConsumer  # 等待 Pod 调度后再绑定
```

PV
```yaml
# harbor-pvs-fixed.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: harbor-registry-pv
spec:
  capacity:
    storage: 45Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteOnce
  storageClassName: local-storage
  local:
    path: /data/harbor/registry
  nodeAffinity:
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values:
                - node01  # 替换为您的 node01 实际节点名
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: harbor-database-pv
spec:
  capacity:
    storage: 5Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteOnce
  storageClassName: local-storage
  local:
    path: /data/harbor/database
  nodeAffinity:
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values:
                - node01
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: harbor-redis-pv
spec:
  capacity:
    storage: 1Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteOnce
  storageClassName: local-storage
  local:
    path: /data/harbor/redis
  nodeAffinity:
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values:
                - node01
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: harbor-chartmuseum-pv
spec:
  capacity:
    storage: 5Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteOnce
  storageClassName: local-storage
  local:
    path: /data/harbor/chartmuseum
  nodeAffinity:
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values:
                - node01
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: harbor-trivy-pv
spec:
  capacity:
    storage: 2Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteOnce
  storageClassName: local-storage
  local:
    path: /data/harbor/trivy
  nodeAffinity:
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values:
                - node01

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: harbor-jobservice-pv
spec:
  capacity:
    storage: 2Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteOnce
  storageClassName: local-storage
  local:
    path: /data/harbor/jobservice
  nodeAffinity:
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values:
                - node01

```

在 node01 节点是上创建目录
```bash
what02@node01:/data/harbor$ ll
总计 32
drwxr-xr-x 8 root root  4096 10月 22 17:21 ./
drwxr-xr-x 3 root root  4096 10月 22 17:14 ../
drwxrwsr-x 3 root   999 4096 10月 22 17:17 chartmuseum/
drwxr-xr-x 2 root root  4096 10月 22 17:14 database/
drwxrwsrwx 2 root 10000 4096 10月 22 17:21 jobservice/
drwxrwsr-x 2 root   999 4096 10月 23 16:01 redis/
drwxrwsr-x 2 root 10000 4096 10月 22 17:14 registry/
drwxrwsr-x 4 root 10000 4096 10月 22 17:17 trivy/
```

## 准备好证书


创建自签名证书,同时 支持 主域名 `shisan.com` 和泛域名 `*.shisan.com` 
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout tls.key -out tls.crt \
  -subj "/CN=shisan.com" \
  -addext "subjectAltName=DNS:shisan.com,DNS:*.shisan.com"
```

在 Kubernetes 中创建 TLS 密钥：
```bash
kubectl create secret tls harbor-tls --cert=tls.crt --key=tls.key
```


## helm 部署单实例 Harbor 


将 harbor 有关存储的部分部署在 node01 节点上，并且不部署高可用部分

```yaml
# values.yaml - 完全非高可用配置

# -- Harbor 外部访问地址
externalURL: https://harbor.shisan.com

# -- 服务暴露配置
expose:
  type: ingress
  tls:
    enabled: true
    certSource: secret
    secret:
      secretName: harbor-tls
      notarySecretName: harbor-tls

  ingress:
    hosts:
      core: harbor.shisan.com
    className: "traefik"
    annotations:
      # 指定 entrypoints
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
      # tls
      traefik.ingress.kubernetes.io/router.tls: "true"
      #traefik.ingress.kubernetes.io/router.middlewares: harbor-redirectscheme@kubernetescrd

# -- Harbor 管理员密码
harborAdminPassword: "admin@123"

# -- 持久化存储配置
persistence:
  enabled: true
  resourcePolicy: "keep"
  persistentVolumeClaim:
    registry:
      storageClass: "local-storage"
      accessMode: ReadWriteOnce
      size: 40Gi
    chartmuseum:
      storageClass: "local-storage"
      accessMode: ReadWriteOnce
      size: 10Gi
    jobservice:
      jobLog:
        storageClass: "local-storage"
        accessMode: ReadWriteOnce
        size: 2Gi
    database:
      storageClass: "local-storage"
      accessMode: ReadWriteOnce
      size: 5Gi
    redis:
      storageClass: "local-storage"
      accessMode: ReadWriteOnce
      size: 1Gi
    trivy:
      storageClass: "local-storage"
      accessMode: ReadWriteOnce
      size: 2Gi

# -- 数据库配置 - 单实例
database:
  internal:
    password: "admin@123"
  # 单实例配置
  replicas: 1
  nodeSelector:
    kubernetes.io/hostname: "node01"  # 指定部署到node01
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

# -- Redis 配置 - 单实例
redis:
  internal:
    password: "admin@123"
  # 单实例配置
  replicas: 1
  nodeSelector:
    kubernetes.io/hostname: "node01"  # 指定部署到node01
  resources:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

# -- Trivy 配置 - 单实例
trivy:
  enabled: true
  replicas: 1
  nodeSelector:
    kubernetes.io/hostname: "node01"  # 指定部署到node01
  ignoreUnfixed: true
  resources:
    requests:
      memory: "512Mi"
      cpu: "200m"
    limits:
      memory: "1Gi"
      cpu: "500m"

# -- Harbor 核心组件配置 - 全部单实例
core:
  secret: "admin@123"
  # 替换为你生成的 32 字符字符串 - openssl rand -hex 16   一个用于生成随机 16 字节(32字符)（128 位）数据并以十六进制形式输出的命令
  xsrfKey: "1653089a3fdf046455aaa16d793517f0"
  # 替换为你生成的 32 字符字符串 - openssl rand -hex 16   一个用于生成随机 16 字节(32字符)（128 位）数据并以十六进制形式输出的命令
  csrfKey: "6c22a4df267aa2c3ac81ac104c4d1660"  
  replicas: 1
  nodeSelector:
    kubernetes.io/hostname: "node01"  # 指定部署到node01
  resources:
    requests:
      memory: "512Mi"
      cpu: "200m"
    limits:
      memory: "1Gi"
      cpu: "1000m"

# -- 任务服务配置 - 单实例
jobservice:
  replicas: 1
  nodeSelector:
    kubernetes.io/hostname: "node01"  # 指定部署到node01
  jobLogger: "file"
  maxJobWorkers: 5
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

# -- 注册表配置 - 单实例
registry:
  replicas: 1
  nodeSelector:
    kubernetes.io/hostname: "node01"  # 指定部署到node01
  credentials:
    username: "admin"
    password: "admin@123"
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

# -- 功能组件配置 - 全部单实例
chartmuseum:
  enabled: true
  replicas: 1

portal:
  enabled: true
  replicas: 1

notary:
  enabled: false

# -- 完全禁用所有高可用特性
# 无负载均衡配置
# 无反亲和性配置
# 无多副本配置
```


使用 helm 部署
```bash
# 添加Harbor chart仓库
helm repo add harbor https://helm.goharbor.io
helm repo update


# 安装Harbor
helm install harbor harbor/harbor   --values values.yaml
```


## 验证

```bash
# 检查所有组件状态
kubectl get pods  -o wide

# 检查 PVC 绑定状态
kubectl get pvc 

# 检查 PV 绑定状态
kubectl get pv

# 查看存储使用情况
kubectl exec -it <harbor-core-pod> -- df -h
```

查看 ingress
```bash
kubectl get ingress
NAME             CLASS     HOSTS        ADDRESS        PORTS     AGE
harbor-ingress   traefik   harbor.shisan.com   192.168.4.10   80, 443   5h17m
```


# 使用

1. 需要提前创建好项目


## 使用 IDEA + Docker Desktop 将镜像推送到仓库

1. docker desktop 登录



