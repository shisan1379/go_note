

# 冯.诺依曼模型和计算机系统


## 冯诺依曼模型

**主机**
1. 运算器

1. 存储器
    主要是内存

1. 控制器


其中运算器和控制器主要就是CPU及相关的功能，存储器主要是内存


**外设**

1. 输入设备

1. 输出设备

## 计算机操作系统

没有配置软件的主机，仅仅构成了计算机的硬件基础，将裸机进行软件配置改造后，成为更强大的机器成为虚拟机或扩展机。

操作系统是逻辑上的第一层软件，是最基本的系统软件。


### 引入OS的目的

1. 有效控制和管理计算机软件、硬件资源
1. 合理组织计算机系统的工作流程，改善性能
1. 提供用户与计算机硬件之间的接口

# 操作系统的概念

## 用户的观点

根据用户所使用计算机的不同设计不同类型的操作系统，例如：windiws、安卓、Linux 等

## 系统观点也是资源管理的观点

**操作系统是计算机系统的资源管理程序**

1. 处理器管理
1. 存储器管理
1. 设备管理
1. 信息管理(文件系统)

**OS 本身和用户作业赖以活动的物质基础和工作环境**
1. 处理器
1. 存储器
1. 外设
1. 信息（程序和数据）


## 进程观点
由若干个可以独立运行的程序和一个对这些程序进行协调的核心所组成

运行中的程序分为两种
- 用户进程
- 系统进程


## 虚拟机观点即机器扩充的观点

- 操作系统为用户提供许多服务功能和良好的工作环境
- 将操作系统分为若干层次，每一层次完成特定的功能，从而构成一个虚拟机，并未上一层提供支持



# 操作系统的特征

## 并发性
多个事件在 **同一时间间隔** 内发生，这里并不是同时。

并行才是只多个事件同时刻发生

## 共享性

硬件和软件不在为某个程序独占，共享有两种方式

1. 互斥共享：同一时刻只能有一个进程访问该资源，例如打印机、磁带等物理设备。该资源称之为临界资源或者独占资源

1. 同时访问：允许若干个用户同时访问文件，但是这是以 **分时共享** 的形式。

    **分时共享**： 在单处理机上，宏观上是同时，微观上是交替访问的，例如：磁盘，可重入的代码


## 虚拟性
操作系统会把一个物理上的实体变为若干逻辑上的对应物

## 异步性
程序执行顺序和执行时间都是不可预知的


### 并发性和共享性

并发性和共享性是操作系统的基本特征，二者互为存在条件

# 操作系统的主要功能

## 处理器管理
1. 进程控制
1. 进程同步
1. 进程通信
1. 进程调度

## 存储器管理
1. 内存分配与回收
1. 内存保护与共享
1. 内存扩充
1. 地址映射

## 设备管理
主要任务是完成用户的 I/O 请求

1. 设备分配
1. 设备传输控制
1. 设备独立性

## 文件管理

1. 文件存储空间管理
1. 目录管理
1. 文件操作管理（读、写）
1. 文件保护

## 用户接口

1. 命令接口
    1. 联机命令接口 - 交互式命令接口
    1. 脱机命令接口 - 批处理作业接口

1. 图形接口


1. 程序接口

    - 为用户程序在执行中访问系统资源而设置的，是用户程序取得操作系统服务的唯一途径

    - 系统调用
        - 系统调用是操作系统为应用程序使用内核功能，给用户提供的接口之一
        - 由于运行在内核空间，所以使用系统调用需要上下文的切换以及状态的转换，也就是**用户态到内核态**




# 操作系统发展过程

## 1.无操作系统阶段
**特点**
1. 用户独占计算机资源
1. 资源利用率低
1. CPU等待

## 2.单道批处理系统

最早出现的一种操作系统

特点
1. 自动性
1. 顺序性
1. 单道性 - 内存中仅有一道程序在运行

## 3.多道批处理系统

特点
1. 多道性
1. 宏观上并行
1. 微观上串行 ，内存中的多道程序轮流使用 CPU

优点

1. 资源利用率高 - 内存中的多道程序轮流使用CPU
1. 系统吞吐量大 
    1. CPU是其他资源保持 忙碌 状态
    1. 仅当作业完成时或运行不下去才进行切换，系统开销小


缺点
1. 用户响应时间较长
1. 没有人机交互能力
    用户几不了解运行情况，也不能控制计算机

# 操作系统的分类


## 批处理操作系统
1. 用户脱机使用计算机
1. 成批处理
1. 多道程序运行


## 分时操作系统

**分时技术**：把处理器的运行时间，分成很短的时间片，按照时间片轮流把处理器分配给各联机作业使用

### 实现方法
1. 简单分时操作系统
1. 具有前台、后台的分时操作系统
1. 多道分时操作系统

### 特征

- 多路性 - 同时性

- 独占性

- 及时性

- 交互性


## 实时操作系统

### 分类

- 实时工业/武器操作系统

- 实时信息处理系统

- 实时多媒体系统

- 实时嵌入式系统

### 特点

- 多路性 - 体现在周期性或多个对象或多个执行机构进行控制

- 交互性
- 独占性
- 及时性
- 高可靠 - 采用多级容错





## 通用操作系统

如果一个操作系统同时拥有以上三种或两种功能，则称之为通用操作系统


## 其他操作系统

1. 嵌入式操作系统

1. 集群操作系统
    将两个或多个独立的系统耦合起来完成同一项任务

1. 网络操作系统
    - 是一个互联的计算机系统的群体
    - 每台计算机都是自治的
    - 系统互连通过通信设施实现
    - 实现相互通信和资源共享

1. 分布式操作系统

    将多个分散的处理单元经互联网连接而成的系统

    **特点**
    1. 统一性
    1. 共享性
    1. 透明性
    1. 自治性

    **优点**
    1. 分布式
    1. 可靠性



# 操作系统的运行环境



## 处理器执行状态

### 核心态(管态、系统态、内核态)

能执行一切指令，能访问所有寄存器和存储区


### 用户态(目态)

只能执行规定的指令(用户程序),只能访问指定的寄存器和存储区

用户态不能直接调用核心态程序，而是通过访问核心态的命令，触发中断，由中断转入操作系统内的相应程序，从而间接调用核心态程序


#### 用户态转核心态的例子
只能通过系统调用、中断或异常

1. 用户要求操作系统服务，即系统调用

1. 发生中断

1. 程序运行产生错误状态

1. 用户程序企图执行特权命令

1. 由核心态专项用户态的一条指令：例如中断返回指令

1. 访管指令（非特权指令） - 引起访管中断


## 内核的指令操作在核心态

### 时钟管理

时钟是最关键的设备，时钟的第一功能是计时，还可以通过时钟中断管理，实现进程切换


### 中断机制

最初为了提高多道程序运行环境中CPU利用率，而且主要是针对外部设备，现在成了操作系统各项操作的基础

中断的基本概念：中断是指CPU在执行一个程序时，对程序发生的某个事件（程序自身或外界的原因）作出的一种反应。当中断发生时，CPU会暂停正在执行的程序，保存当前程序的运行现场，然后自动转去处理相应的事件。处理完该事件后，CPU会返回到之前的程序断点，继续执行被中断的程序。中断具有随机性、可恢复性和自动性的特点。

中断处理的过程：

1. 中断请求：当外部设备或其他内部事件需要处理时，会发送一个中断请求信号给中央处理器（CPU）。这个中断请求信号会触发中断控制器，向CPU发送中断信号。

1. 中断响应：CPU接收到中断信号后，会立即停止当前正在执行的指令，并保存当前的执行状态（包括程序计数器、寄存器状态等），以便稍后能够恢复执行。

1. 中断处理程序调用：CPU根据中断信号的种类和优先级，选择相应的中断处理程序。中断处理程序是预先定义好的一段代码，用来处理特定的中断事件。

1. 中断处理程序执行：CPU跳转到相应的中断处理程序，开始执行具体的中断处理操作。这可能涉及与外部设备的交互或处理一些必要的操作，如保存当前上下文、保存中断源的信息等。
1. 中断处理完成：中断处理程序执行完毕后，CPU会恢复之前保存的执行状态，并继续执行被中断的程序。

中断的分类：

1. 输入输出中断：当外部设备或通道操作正常结束或发生某种错误时发生的中断，例如I/O传输出错、I/O传输结束等。

1. 外中断：对某中央处理机而言，由外部非通道式装置所引起的中断称为外部中断，例如时钟中断、操作员控制台中断等。

1. 机器故障中断：当机器发生故障时所产生的中断称为硬件故障中断，例如电源故障、存储错误等。

1. 程序性中断：在现行程序执行过程中，发现了程序性的错误或出现了某些程序的特定状态而产生的中断，例如定点溢出、非法操作等。

1. 中断的实例：在操作系统中，中断常常用于实现进程切换和系统调用等功能。例如，当一个进程的时间片用完时，计时部件会发出中断信号，CPU会切换到核心态处理该中断，操作系统会进行进程切换，将CPU的使用权交给另一个进程。另外，当进程发出系统调用请求时，也会通过中断机制来通知操作系统介入工作。

总的来说，操作系统的中断机制是实现多任务处理和系统资源管理的重要手段，它确保了计算机能够高效地响应和处理各种事件。


### 原语

在操作系统中，原语（primitive or atomic action）是由若干条指令组成的程序段，用于实现某个特定功能。这些指令在执行过程中是不可被中断的，具有不可分割性。原语是操作系统核心的一个组成部分，它不是由进程而是由一组程序模块所组成，通常常驻内存并在管态（一种特殊的机器状态，允许执行特权和非特权两类指令）下执行。

原语在操作系统中扮演着非常重要的角色，它用于实现一些关键的操作，如队列操作、对信号量的操作、检查启动外设操作等。这些操作一旦开始执行，就不能被中断，否则可能会导致操作错误和系统混乱。因此，原语提供了一种机制，确保这些关键操作能够连续、无中断地完成。

此外，原语还可以被看作是操作系统提供给程序员的基本操作，它们提供了与计算机硬件交互的能力，并且是构建操作系统的基础。原语的主要特点是其不可分割性，即执行过程中不可被中断或暂停。

总的来说，原语在操作系统中是一种关键的编程构造，用于实现特定功能并确保操作的连续性和完整性。


### 系统控制的数据结构及处理

**登记状态信息的数据结构**

- 作业控制块

- 进程控制块

- 设备控制块

- 各类链表

- 消息队列

- 缓冲器

- 空闲登记区

- 内存分配表

- ....

**定义对这些数据结构的操作**

1. 进程管理

1. 存储器管理

1. 设备管理


## 中断与异常


中断，也称外中断是系统的正常功能，分为外设请求、人工干预


异常：也称内中断，一般是由错误引起的

- 文件损坏
- 进程越界
- 算术溢出
- 硬件故障
- 软件中断

> 异常一般会引起中断，但中断未必是由异常引起的


**中断处理的过程**

1. 关中断
2. 保存断点
3. 中断服务程序寻址
4. 保存现场和屏蔽字
5. 开中断
6. 执行中断服务程序
7. 关中断
8. 恢复现场和屏蔽字
9. 开中断，中断返回

1 ~ 3 由硬件(中断隐指令) 自动完成 4 ~ 9 由中断程序完成



## 系统调用（核心态）

用户在程序调用操作系统所提供的一些子功能

- 设备管理：完成设备的请求、释放、启动等功能
- 文件管理：完成文件的读写、创建和删除功能
- 进程控制：完成进程的创建、撤销和删除功能
- 进程通信：完成进程之间的消息传递或信号传递等功能
- 内存管理：完成内存的分配、回收、以及获取作业占用内存区大小及始址功能


# 操作系统的体系结构

## 模块化结构

优点
1. 结构紧密，接口简单、系统的效率相对较高

缺点
1. 系统结构不清晰，可扩展性差，可适应性差

只适用于系统小、模块少、使用环境比较稳定的系统


## 层次结构
模块之间单向调用和单向依赖

优点：
1. 模块之间组织和依赖关系清晰明了
1. 便于修改和扩充

缺点
1. 必须把与机器特点紧密相关的软件（中断处理、输入输出）放在最底层

1. 要将常用的操作放在内层，而降随着这些操作方式改变的部分放在外层

1. 为进程提供服务的系统调用模块放在系统内层

1. 系统效率低

## 微内核结构

在操作系统内核中只留下一些最基本的功能，将其他服务尽可能的从内核中分离出去，用若干个运行在内核态的进程（服务进程）来实现，形成C/S模式

优点
1. 可靠性好
1. 灵活性好
1. 便于维护
1. 适合分布式处理的计算环境

缺点
1. 效率不高，尤其是通信频繁的系统