

# kubelet

kubelet 是部署在每一个常规集群节点上的核心组件，它负责在每个节点上管理和运行容器。

kubelet 的主要任务是确保容器在节点上的正常运行，并接受来自控制平面（如apiserver）的指令

# kubelet的主要功能

## Pod和容器的生命周期管理

1. **pod的调度和创建**： kubelet 从 API Server 接收到调度器分配到本节点的 Pod 定义后，会与容器运行时(Docker / containerd)交互，启动 Pod 中的所有容器
   
2. **容器的启动和停止**： kubelet 负责根据 pod 的生命周期管理容器的启动、停止和删除。当容器因为各种原因崩溃或者退出时， kubelet 会根据 pod 的重启策略（如 Always 、 OnFailure 、Never）决定是否重启该容器
   
## 与容器运行时的接口（CRI）

   
**抽象和适配：** kubelet 通过容器运行时接口（Container Runtime Interface, CRI）与具体的容器进行通信。这个接口使得 kubelet 可以支持不同的容器运行时，如 Docker 、 containerd 、CRI-O等


**容器操作**： 通过 CRI ， kubelet 可以执行一系列容器管理操作，如启动、停止、检查容器状态、收集容器日志等


## 健康检查与自愈

**健康检查探针**： kubelet 通过探针 Probes 定期检查容器的健康状况，包括启动探针 Startup Probe 、存活探针 Liveness Probe 和 就绪探针 Readiness Probe。 这些探针帮助 kubelet 判断容器是否应该被重启或者准备好接收流量


**自动重启**： 如果探针监测到容器并不健康， kubelet 会根据 Pod 的配置自动重启容器，以确保服务的高可用性和稳定性

## 资源管理

**资源分配与监控**： kubelet 负责分配和管理容器的计算资源，如 CPU 和 内存。通过 cgroups(控制组) 和 namespaces(命名空间)集成，kubelet实现了容器的资源隔离和限制，确保不同容器之间的互不干扰

**资源报告**： kubelet 定期向 API Server 汇报节点的资源使用情况，这些数据会被控制平面用来进行调度决策，如将新的 Pod 调度到合适的节点上。


## 日志和监控

**日志管理**：Kubelet 收集容器的标准输出和标准错误日志，并将这些日志暴露给外部日志收集系统（如 Fluentd），以便进行日志聚合和分析。

**监控数据采集**：Kubelet 负责收集节点和容器的监控数据（如 CPU、内存使用情况），这些数据可以被 Prometheus 等监控系统采集，用于实时监控和告警。

## 存储管理

**卷的挂载与管理**：Kubelet 负责将 Pod 所需的存储卷（如 Persistent Volumes）挂载到容器的文件系统中，并在容器终止时卸载这些卷。它支持多种存储后端，如本地存储、NFS、云存储（如 AWS EBS、GCP Persistent Disks）等。

**持久化数据管理**：通过卷的挂载，Kubelet 确保容器间能够共享数据，或者在容器重启后仍能保留数据，支持持久化存储需求。

## 配置管理

**配置数据的分发**：Kubelet 负责将 ConfigMap 和 Secret 挂载到容器的文件系统中或注入为环境变量，使容器化应用能够动态获取和使用配置数据和敏感信息。

**动态更新支持**：Kubelet 支持在不重启容器的情况下动态更新 Pod 的配置，例如更新环境变量或文件配置。


## 节点健康监控与报告


**节点自我监控**：Kubelet 定期检查节点自身的健康状况，包括网络、存储、CPU、内存等资源的可用性。如果节点检测到自身存在问题（如磁盘满了、网络不可达），Kubelet 会将这些信息上报给控制平面。

**健康状态报告**：Kubelet 将节点和 Pod 的健康状态定期报告给 API Server。这些信息对于 Kubernetes 的调度器决定是否将新的工作负载分配到节点上非常关键。

## 安全与证书管理

**证书管理**：Kubelet 使用证书与 API Server 进行加密通信，确保数据传输的安全性。它负责管理这些证书的生成、续期和更新。

**Pod 安全策略执行**：Kubelet 可以强制执行 Pod 安全策略（如 PodSecurityPolicy），限制容器的权限级别，确保容器的运行环境符合安全要求。